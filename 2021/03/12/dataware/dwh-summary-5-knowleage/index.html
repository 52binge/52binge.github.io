<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Hive Optimization Solution Notes - Auckland New Zealand</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="keywords" content="SQL">
<meta property="og:type" content="article">
<meta property="og:title" content="Hive Optimization Solution Notes">
<meta property="og:url" content="http:&#x2F;&#x2F;iequa.com&#x2F;2021&#x2F;03&#x2F;12&#x2F;dataware&#x2F;dwh-summary-5-knowleage&#x2F;index.html">
<meta property="og:site_name" content="Auckland New Zealand">
<meta property="og:locale" content="en">
<meta property="og:image" content="http:&#x2F;&#x2F;iequa.com&#x2F;images&#x2F;hadoop&#x2F;hadoop-hive-logo-1.png">
<meta property="og:updated_time" content="2021-04-07T08:14:30.946Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http:&#x2F;&#x2F;iequa.com&#x2F;images&#x2F;hadoop&#x2F;hadoop-hive-logo-1.png">
  
  
    <link rel="icon" href="/css/images/favicon-Tiktok.ico">
  
  <link href="/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
  <link href="/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <!-- blair add baidu tongji start... @2017.10.03 -->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?8864dc75a81a27b7e44c00138af95d66";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<!-- blair add baidu tongji end ! @2017.10.03 -->

<!-- jiangting add start... @2020.08.30 -->
<!-- <div id="menu" class="duration-main" style="background-color: #e7e7e7"> -->
<!--   <p class="links-p" href="/">Blair</p> -->
<!--   <address class="icons"> -->
<!--     <a href="https://github.com/blair101" class="icon-font icon linkedin" target="_blank"></a> -->
<!--     <a href="https://cn.linkedin.com/pub/tianyu-dai/a8/818/44a" class="icon-font icon linkedin" target="_blank"></a> -->
<!--   </address> -->
<!--   <div class="hr1"></div> -->
<!--   <nav> -->
<!--     <div> -->
<!--     <a class="home" href="/">Home</a></div> -->
<!--     <p class="links-p" href="/">Home</p> -->
<!--     <nav class="tag-ath"> -->
<!--       <a class="proj" href="/categories">Category</a> -->
<!--       <a class="authors" href="/about">About</a> -->
<!--     </nav> -->
<!--   </nav> -->
<!--   <div class="hr2"></div> -->
<!--     <p class="links-p">Links</p> -->
<!--       <address class="links"> -->
<!--       <a class="proj" href="/article/Create-MyWorld">Projects</a> -->
<!--       <a class="friend">Friends</a></address><div class="hr3"> -->
<!--   </div> -->
<!--   <p class="end"></p> -->
<!--   <div id="menu-links" class="duration-main" style="top: -400px; background-color: #f5f5f5"> -->
<!--     <address> -->
<!--       <li><a target="_blank" href="http://lm7.xxxxxxxx.jp">Lm7</a></li> -->
<!--       <li><a target="_blank" href="http://www.pixiv.net/member.php?id=4933015">Domik</a></li> -->
<!--       <li><a target="_blank" href="http://hana-ui.moe">hana-ui</a></li> -->
<!--       <li><a target="_blank" href="http://fil.dtysky.moe">F-I-L</a></li> -->
<!--       <li><a target="_blank" href="http://paradise.dtysky.moe">Paradise</a></li> -->
<!--       <li><a target="_blank" href="http://moe-notes.dtysky.moe">MoeNotes</a></li> -->
<!--       <li><a target="_blank" href="http://kanata.dtysky.moe">Kanata</a></li> -->
<!--       <li><a target="_blank" href="http://blog.nekohand.moe">Nekohand</a></li> -->
<!--       <li><a target="_blank" href="http://www.jerryfu.net">JerryFu</a></li> -->
<!--       <li><a target="_blank" href="http://kawabangga.com">南史</a></li> -->
<!--       <li><a>Hide Links</a></li> -->
<!--       <li><a></a></li> -->
<!--     </address> -->
<!--   </div> -->
<!-- </div> -->
<!-- jiangting add end !  @2020.08.30 -->

<header id="header">
  <div id="header-outer" class="outer">
    <div id="header-inner" class="inner">
      <a id="main-nav-toggle" class="nav-icon" href="javascript:;" target="_blank" rel="noopener"></a>
      <a id="logo" class="logo" href="/"></a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/categories">Categories</a>
        
          <a class="main-nav-link" href="/tweet">Tweet</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://iequa.com"></form>
        </div>
      </nav>
    </div>
  </div>
</header>

    <br>
    <section id="main" class="outer"><article id="post-dataware/dwh-summary-5-knowleage" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Hive Optimization Solution Notes
      <small class=article-detail-date-index>&nbsp; 2021-03-12</small>
    </h1>
  


        <div class=page-title></div>
        <br>
      </header>
    
    <div class="article-meta">
      <!--<a href="/2021/03/12/dataware/dwh-summary-5-knowleage/" class="article-date">
  <time datetime="2021-03-12T01:07:21.000Z" itemprop="datePublished">2021-03-12</time>
</a>-->
      <!-- 
  <div class="article-category">
    <a class="article-category-link" href="/categories/data-warehouse/">data-warehouse</a>
  </div>

--><!-- by blair 160724 -->
      <!-- by blair
      
        <div class="article-comment-link-wrap">
          <a href="http://iequa.com/2021/03/12/dataware/dwh-summary-5-knowleage/#disqus_thread" class="article-comment-link">Comments</a>
        </div>
      
      -->
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <img src="/images/hadoop/hadoop-hive-logo-1.png" width="450" alt="Hadoop MapReduce" />
<a id="more"></a>
<h2 id="hive-优化"><a class="markdownIt-Anchor" href="#hive-优化"></a> Hive 优化</h2>
<table>
<thead>
<tr>
<th style="text-align:center">No.</th>
<th>Hive 优化</th>
<th style="text-align:left">Flag</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1.</td>
<td>explain</td>
<td style="text-align:left">explain [extended] query</td>
</tr>
<tr>
<td style="text-align:center">2.</td>
<td>Column cropping<br><br>列裁剪</td>
<td style="text-align:left">set hive.optimize.cp = true; # 列裁剪，取数只取查询中需要用的列，默认true</td>
</tr>
<tr>
<td style="text-align:center">3.</td>
<td>谓词下推<br><br>Predicate pushdown</td>
<td style="text-align:left">set hive.optimize.ppd=true; # 默认是true<br><br><code>select a.*, b.* from a join b on a.id = b.id where b.age &gt; 20;</code></td>
</tr>
<tr>
<td style="text-align:center">4.</td>
<td>Partition crop <br> 分区裁剪</td>
<td style="text-align:left">set hive.optimize.pruner=true; # 默认是true</td>
</tr>
<tr>
<td style="text-align:center">5.</td>
<td>Merge small files<br>合并小文件<br><br><br> Map input merge</td>
<td style="text-align:left">如果一个mapreduce job碰到一对小文件作为输入，一个小文件启动一个Task<br><br><strong>Map 输入合并:</strong><br><br># Map端输入、合并文件之后按照block的大小分割（默认）set <br> hive.input.format=org.apache.hadoop.hive.ql.io.CombineHiveInputFormat;<br><br># Map端输入，不合并<br>set hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;<br><br></td>
</tr>
<tr>
<td style="text-align:center">5.</td>
<td>合并小文件 <br><br><br><br> Map/Reduce输出合并</td>
<td style="text-align:left">大量的小文件会给 HDFS 带来压力，影响处理效率.<br>可以通过合并 Map 和 Reduce 的结果文件来消除影响 <br><br> 是否合并Map输出文件, 默认值为true<br>set hive.merge.mapfiles=true;<br><br> 是否合并Reduce端输出文件,默认值为false<br>set hive.merge.mapredfiles=true;</td>
</tr>
<tr>
<td style="text-align:center">6.</td>
<td>设置MapTask并行度</td>
<td style="text-align:left">1、减少 MapTask 数是通过合并小文件来实现，这一点主要是针对数据源<br>2、增加 MapTask 数可以通过控制上一个 job 的 reduceTask 个数<br><br>重点注意：不推荐把这个值进行随意设置！<br>推荐的方式：使用默认的切块大小即可。如果非要调整，最好是切块的N倍数<br><br> default_mapper_num = total_size / dfs_block_size <br><br> set mapred.map.tasks=10; # 默认值是2, 大于 default_mapper_num 才生效 <br><br><strong>总结一下控制 mapper 个数的方法</strong>：<br>1. 如果想增加 MapTask 个数，可以设置 mapred.map.tasks 为一个较大的值<br>2. 如果想减少 MapTask 个数，可以设置 maperd.min.split.size 为一个较大的值<br>3. 如果输入是大量小文件，想减少 mapper 个数，可以通过设置 hive.input.format 合并小文件</td>
</tr>
<tr>
<td style="text-align:center">7.</td>
<td>设置ReduceTask并行度</td>
<td style="text-align:left">可以通过改变上述两个参数的值来控制 ReduceTask 的数量. 也可以通过: <br><br> set mapred.map.tasks=10; <br> set mapreduce.job.reduces=10;</td>
</tr>
<tr>
<td style="text-align:center">8.</td>
<td>Join优化</td>
<td style="text-align:left">1. 优先过滤后再进行Join操作，最大限度的减少参与join的数据量<br>2. 小表join大表，最好启动mapjoin，hive自动启用mapjoin, 小表不能超过25M，可以更改<br>3. Join on的条件相同的话，最好放入同一个job，并且join表的排列顺序从小到大<br>4. 如果多张表做join, 如果多个链接条件都相同，会转换成一个Job<br><br><strong>大表Join大表</strong> <br> 1. 空key过滤 <br>2. 空key转换</td>
</tr>
<tr>
<td style="text-align:center">9.</td>
<td>启用 MapJoin</td>
<td style="text-align:left">是否根据输入小表的大小，自动将reduce端的common join 转化为map join，将小表刷入内存中 <br> 对应逻辑优化器是MapJoinProcessor <br><br> <code>set hive.auto.convert.join = true;</code><br><br># 刷入内存表的大小(字节)<br>set hive.mapjoin.smalltable.filesize = 25000000;<br><br> # hive会基于表的size自动的将普通join转换成mapjoin <br> set hive.auto.convert.join.noconditionaltask=true;<br><br> # 多大的表可以自动触发放到内层LocalTask中，默认大小10M<br>set hive.auto.convert.join.noconditionaltask.size=10000000; <br><br> <strong>也可以手动开启mapjoin</strong>：</td>
</tr>
<tr>
<td style="text-align:center">10.</td>
<td><br><br><code>Join数据倾斜优化</code></td>
<td style="text-align:left"># join的key对应的记录条数超过这个值则会进行分拆，值根据具体数据量设置<br>set <code>hive.skewjoin.key</code>=100000;<br><br># 如果是join过程出现倾斜应该设置为true<br>set <code>hive.optimize.skewjoin</code>=false;<br><br>通过 hive.skewjoin.mapjoin.map.tasks 参数还可以控制第二个 job 的 mapper 数量，默认10000<br>set hive.skewjoin.mapjoin.map.tasks=10000;</td>
</tr>
<tr>
<td style="text-align:center">13.</td>
<td>Group By优化</td>
<td style="text-align:left"><strong>1. Map端部分聚合</strong> <br><br> # 开启Map端聚合参数设置 set hive.map.aggr=true;<br># 设置map端预聚合的行数阈值，超过该值就会分拆job，默认值100000<br>set hive.groupby.mapaggr.checkinterval=100000 <br><br> <strong>2. 有数据倾斜时进行负载均衡</strong><br><br>当 HQL 语句使用 group by 时数据出现倾斜时，如果该变量设置为 true，那么 Hive 会自动进行负载均衡。<br>策略就是把 MapReduce 任务拆分成两个： 第1个先做预汇总，第2个再做最终汇总. <br><br> # 自动优化，有数据倾斜的时候进行负载均衡（默认是false） <br> set hive.groupby.skewindata=false;</td>
</tr>
<tr>
<td style="text-align:center">15.</td>
<td>Count Distinct优化</td>
<td style="text-align:left">优化后（启动2个job，1个job负责子查询(可有多个reduce)，另1个job负责count(1)): <br> <code>select count(1) from (select id from tablename group by id) tmp;</code></td>
</tr>
<tr>
<td style="text-align:center">16.</td>
<td>怎样写in/exists语句</td>
<td style="text-align:left">– in / exists 实现 <br><code>select a.id, a.name from a where a.id in (select b.id from b);</code><br><br>是推荐使用 Hive 的一个高效替代方案：left semi join<br><code>select a.id, a.name from a left semi join b on a.id = b.id;</code></td>
</tr>
</tbody>
</table>
<p><strong>手动开启mapjoin：</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--SQL方式，在SQL语句中添加MapJoin标记（mapjoin hint）</span></span><br><span class="line"><span class="comment">--将小表放到内存中，省去shffle操作</span></span><br><span class="line">// 在没有开启mapjoin的情况下，执行的是reduceJoin</span><br><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ MAPJOIN(smallTable) */</span> smallTable.key, bigTable.value <span class="keyword">FROM</span></span><br><span class="line">smallTable <span class="keyword">JOIN</span> bigTable <span class="keyword">ON</span> smallTable.key = bigTable.key;</span><br><span class="line"><span class="comment">/*+mapjoin(smalltable)*/</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:center">No.</th>
<th>Hive 优化</th>
<th style="text-align:center">Flag</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1.</td>
<td>join 优化, order &amp; customer - 先过滤在Join</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">2.</td>
<td>union优化： （union 去掉重复的记录）而是使用 union all 然后在用group by 去重</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">3.</td>
<td>count distinct优化, 使用子查询</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">4.</td>
<td>用in 来代替join</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">5.</td>
<td>消灭子查询内的 group by 、 COUNT(DISTINCT)，MAX，MIN。可以减少job的数量</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">6.</td>
<td>join 优化 - set hive.auto.convert.join=true; 小表自动判断，在内存  <br>   Sort -Merge -Bucket Join  对大表连接大表的优化</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">7.</td>
<td>数据倾斜 - SQL 导致 <br> 1. group by维度变得更细 2. 值为空的情况单独处理 3. 不同数据类型关联产生数据倾斜（int,string） <br><br> group by维度不能变得更细的时候,就可以在原分组key上添加随机数后分组聚合一次, 然后对结果去掉随机数后再分组聚合,在join时，有大量为null的join key，则可以将null转成随机值，避免聚集</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">8.</td>
<td>数据倾斜 - 业务数据本身导致 - 热点值和非热点值分别进行处理</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">9.</td>
<td>数据倾斜 - key本身不均 - 可以在key上加随机数，或者增加reduceTask数量</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">10.</td>
<td>合并小文件 - 小文件的产生有三个地方，map输入，map输出，reduce输出</td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WITH</span> x <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        app,</span><br><span class="line">        user_id,</span><br><span class="line">        <span class="keyword">count</span>( <span class="number">1</span> ) <span class="keyword">AS</span> rn </span><br><span class="line">    <span class="keyword">FROM</span></span><br><span class="line">        table1 </span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">        app,</span><br><span class="line">        user_id </span><br><span class="line">    ) </span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    t.app,</span><br><span class="line">    t.user_id </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        app,</span><br><span class="line">        user_id,</span><br><span class="line">        row_number ( ) <span class="keyword">over</span> ( <span class="keyword">PARTITION</span> <span class="keyword">BY</span> app <span class="keyword">ORDER</span> <span class="keyword">BY</span> rn <span class="keyword">DESC</span> ) <span class="keyword">AS</span> max_user </span><br><span class="line">    <span class="keyword">FROM</span></span><br><span class="line">        x </span><br><span class="line">    ) <span class="keyword">AS</span> t </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    t.max_user &lt;= <span class="number">5</span></span><br></pre></td></tr></table></figure>
<p><a href="https://mp.weixin.qq.com/s?__biz=Mzg3NjIyNjQwMg==&amp;mid=2247493676&amp;idx=1&amp;sn=1658835f7c595cce105022e70640e020&amp;chksm=cf37da21f8405337445ce6d8edbe4640b1a6dbd7903dfd6ac7cd2edbd83394a372bd2e3b9997&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">再次分享！Hive调优，数据工程师成神之路</a></p>
<p>进程 启动慢 vs 线程 级别<br />
MR中间结果只能存磁盘HDFS, Spark 中间结果可以缓存<br />
Map方法之后Reduce方法之前这段处理过程叫「Shuffle」</p>
<blockquote>
<p>(1). Data Skew 的原理很简单：在进行shuffle的时候，必须将各个节点上相同的key拉取到某个节点上的一个task来进行处理，比如按照key进行聚合或join等操作。此时如果某个key对应的数据量特别大的话，就会发生 Data Skew。</p>
<p>(2). Task 有2个非常慢</p>
</blockquote>
<p>Hive</p>
<p>(1). Count Distinct 改为 Group by<br />
(2). 在小表和大表进行join时，将小表放在前边，效率会高。hive会将小表进行缓存。</p>
<p>2、mapjoin</p>
<p>使用mapjoin将小表放入内存，在map端和大表逐一匹配。从而省去reduce。</p>
<p>样例：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="comment">/*+MAPJOIN(b)*/</span> a.a1,a.a2,b.b2 <span class="keyword">from</span> tablea a <span class="keyword">JOIN</span> tableb b <span class="keyword">ON</span> a.a1=b.b1</span><br></pre></td></tr></table></figure>
<p>缓存多张小表：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="comment">/*+MAPJOIN(b,c)*/</span> a.a1,a.a2,b.b2 <span class="keyword">from</span> tablea a <span class="keyword">JOIN</span> tableb b <span class="keyword">ON</span> a.a1=b.b1 <span class="keyword">JOIN</span> tbalec c <span class="keyword">on</span> a.a1=c.c1</span><br></pre></td></tr></table></figure>
<p>Hive0.11版本之后：<br />
hive.auto.convert.join=True<br />
hive.mapjoin.smalltable.filesize<br />
默认值为2500000(25M),通过配置该属性来确定使用该优化的表的大小，如果表的大小小于此值就会被加载进内存中</p>
<p>注意：使用默认启动该优化的方式如果出现默名奇妙的BUG(比如MAPJOIN并不起作用),就将以下两个属性置为fase手动使用MAPJOIN标记来启动该优化</p>
<p>hive.auto.convert.join=false(关闭自动MAPJOIN转换操作)<br />
hive.ignore.mapjoin.hint=false(不忽略MAPJOIN标记)</p>
<p>原文链接：<a href="https://blog.csdn.net/u012036736/article/details/84978689" target="_blank" rel="noopener">https://blog.csdn.net/u012036736/article/details/84978689</a></p>
<p><strong>2.1 参数调节</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">set</span> hive.map.aggr = <span class="literal">true</span> <span class="comment"># 在map中会做部分聚集操作，效率更高但需要更多的内存。</span></span><br><span class="line"><span class="built_in">set</span> hive.groupby.skewindata = <span class="literal">true</span> </span><br><span class="line"><span class="comment"># 数据倾斜的时候进行负载均衡，查询计划生成两个MR job</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 第一个job先进行key随机分配处理，随机分布到Reduce中，每个Reduce做部分聚合操作，先缩小数据量。</span></span><br><span class="line"><span class="comment"># 第二个job再进行真正的group by key处理，根据预处理的数据结果按照Group By Key分布到Reduce中（这个过程可以保证相同的Key被分布到同一个Reduce中）</span></span><br><span class="line"><span class="comment"># 完成最终的聚合操作。</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> hive.merge.mapfiles=<span class="literal">true</span> <span class="comment"># 当出现小文件过多，需要合并小文件</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> hive.exec.reducers.bytes.per.reducer=1000000000 （单位是字节） </span><br><span class="line"><span class="comment"># 每个reduce能够处理的数据量大小，默认是1G。</span></span><br><span class="line"></span><br><span class="line">hive.exec.reducers.max=999 </span><br><span class="line"><span class="comment"># 最大可以开启的reduce个数，默认是999个。在只配了hive.exec.reducers.bytes.per.reducer以及hive.exec.reducers.max的情况下，实际的reduce个数会根据实际的数据总量/每个reduce处理的数据量来决定。</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> mapred.reduce.tasks=-1 </span><br><span class="line"><span class="comment"># 实际运行的reduce个数，默认是-1，可以认为指定，但是如果认为在此指定了，那么就不会通过实际的总数据量hive.exec.reducers.bytes.per.reducer来决定reduce的个数了。</span></span><br></pre></td></tr></table></figure>
<p><strong>2.大表Join大表</strong></p>
<p>把空值的key变成一个字符串加上随机数，把倾斜的数据分到不同的reduce上，由于null值关联不上，处理后并不影响最终结果。如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">log</span> a </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> <span class="keyword">users</span> b </span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line"><span class="keyword">case</span> <span class="keyword">when</span> a.user_id <span class="keyword">is</span> <span class="literal">null</span> </span><br><span class="line"><span class="keyword">then</span> <span class="keyword">concat</span>(<span class="string">'hive'</span>,<span class="keyword">rand</span>()) </span><br><span class="line"><span class="keyword">else</span> a.user_id <span class="keyword">end</span> = b.user_id;</span><br></pre></td></tr></table></figure>
<p>6.小表不小不大，怎么用 map join 解决倾斜问题</p>
<blockquote>
<p>在小表和大表进行join时，将小表放在前边，效率会高。hive会将小表进行缓存。</p>
</blockquote>
<p><strong>Reduce 长尾</strong></p>
<p><code>Count Distinct</code> 的执行原理是将需要去重的宇段 以及 GroupBy宇段联合作为 key将数据分发到 Reduce端。<br />
因为 Distinct操作，数据无法在 Map 端的 Shuffle 阶段根据 Group By 先做一次聚合操作，以减少传输的数据量，而是将所有的数据都传输到 Reduce 端，当 key 的数据分发不均匀时，就会导致 Reduce 端长尾。</p>
<blockquote>
<ol>
<li>对同一个表按照维度对不同的列进行 Count Distinct操作，造成 Map 端数据膨胀，从而使得下游的 Join 和 Reduce 出现链路上的 长尾。</li>
<li>Map 端直接做聚合时出现 key 值分布不均匀，造成 Reduce 端长尾。 .</li>
<li>动态分区数过多时可能造成小文件过多，从而引起 Reduce 端长尾。 .</li>
<li>多个 Distinct 同时出现在一段 SQL 代码时，数据会被分发多次， 会造成数据膨胀 N 倍，长尾现象放大 N 倍.</li>
</ol>
</blockquote>
<p><strong>MapReduce</strong></p>
<blockquote>
<p>(1) Map方法之后Reduce方法之前这段处理过程叫「Shuffle」</p>
<p>(2) Map方法之后，数据首先进入到分区方法，把数据标记好分区，然后把数据发送到环形缓冲区；环形缓冲区默认大小100m，环形缓冲区达到80%时，进行溢写；溢写前对数据进行排序，排序按照对key的索引进行字典顺序排序，排序的手段「快排」；溢写产生大量溢写文件，需要对溢写文件进行「归并排序」；对溢写的文件也可以进行Combiner操作，前提是汇总操作，求平均值不行。最后将文件按照分区存储到磁盘，等待Reduce端拉取。</p>
<p>3）每个Reduce拉取Map端对应分区的数据。拉取数据后先存储到内存中，内存不够了，再存储到磁盘。拉取完所有数据后，采用归并排序将内存和磁盘中的数据都进行排序。在进入Reduce方法前，可以对数据进行分组操作。</p>
</blockquote>
<hr />
<h2 id="reference"><a class="markdownIt-Anchor" href="#reference"></a> Reference</h2>
<p><a href="https://www.cnblogs.com/volcao/p/13636557.html" target="_blank" rel="noopener">大数据：元数据（Metadata）</a><br />
<a href="https://my.oschina.net/u/4631230/blog/4538578" target="_blank" rel="noopener">数据治理之元数据管理</a></p>
<p><a href="https://www.codenong.com/cs107025192/" target="_blank" rel="noopener">数据仓库–数据分层（ETL、ODS、DW、APP、DIM）</a><br />
<a href="https://www.jianshu.com/p/10de9f7de648" target="_blank" rel="noopener">数仓–Theory–数仓命名规范</a><br />
<a href="https://tech.youzan.com/youzan-metadata/" target="_blank" rel="noopener">有赞数据仓库元数据系统实践</a><br />
<a href="https://www.cnblogs.com/jiangbei/p/8483591.html" target="_blank" rel="noopener">【数据仓库】——数据仓库概念</a><br />
<a href="https://monkeyip.github.io/2019/04/25/Hive%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C%E4%BC%98%E5%8C%96%E6%80%BB%E7%BB%93/" target="_blank" rel="noopener">Hive数据倾斜优化总结</a><br />
<a href="https://www.codenong.com/cs107025192/" target="_blank" rel="noopener">数据仓库–数据分层（ETL、ODS、DW、APP、DIM）</a><br />
<a href="https://mp.weixin.qq.com/s/D_mqw4UO8H-ckE5ytfnglg" target="_blank" rel="noopener">网易严选数仓规范与评价体系</a></p>

      
     <!-- by blair add this if sentence at 20160725 -->
      <br>
      
<div id="bottom-donation-section">
<span style="font-size: 1.0em; padding:0em 1em 0.5em 1em; margin: 0 auto;">
  <strong style="vertical-align: top;">分享到:</strong>
    <div class="j_handlclick"  style="background: url(/images/logos/share_facebook_icon.jpg);background-size: contain;display: inline-block; width:50px; height:50px" href="https://www.facebook.com/sharer/sharer.php?u=" target="_blank">
    </div>
    <div class="j_handlclick"  style="background: url(/images/logos/share_twitter_icon.jpg);background-size: contain;display: inline-block; width:50px; height:50px" href="https://twitter.com/intent/tweet?url=" target="_blank">
    </div>
    <div class="j_handlclick"  style="background: url(/images/logos/share_line_icon.jpg);background-size: contain;display: inline-block; width:50px; height:50px" href="https://www.addtoany.com/add_to/line?linkurl=" target="_blank">
    </div>
    <div class="j_handlclick"  style="background: url(/images/logos/share_wechat_icon.jpg);background-size: contain;display: inline-block; width:50px; height:50px" href="https://api.addthis.com/oexchange/0.8/forward/wechat/offer?url=" target="_blank">
    </div>
  <br>  
  <br>  
  &nbsp;&nbsp;如果您觉得这篇文章对您的学习很有帮助, 请您也分享它, 让它能再次帮助到更多的需要学习的人.
您的<a href="/support/"><strong>支持</strong></a>将鼓励我继续创作 !
  <br>  

</span>
<!--
<h3 id="bottom-donation-title">支持 让文章变得更优质</h3>
<div>
<a id="bottom-donation-button" href="/support">点我 赞助 作者</a>
</div>
-->
</div>
<div class="well">
  <!--
  原创文章，转载请注明： 转载自<a href="http://52binge.github.io" target="_blank" rel="noopener"> Blair Chan's Blog</a>，作者：
  <a href="/about">Blair Chan</a> <br>
  -->
  本文基于<a target="_blank" title="Creative Commons Attribution 4.0 international License" href="https://creativecommons.org/licenses/by-nc/4.0/">署名4.0国际许可协议</a>发布，转载请保留本文署名和文章链接。 如您有任何授权方面的协商，请邮件联系我。
</div>
 <!-- by blair add 160724-->
    
    </div>
    
      <div class="article-toc">
        <h3>Contents</h3>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#hive-优化"><span class="toc-text"> Hive 优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reference"><span class="toc-text"> Reference</span></a></li></ol>
      </div>
    
    
      <footer class="article-footer">
        <!-- <div class="well" style="width:100px; height:30px;"></div>  by blair-->
        
  <div class="article-category">
    <a class="article-category-link" href="/categories/data-warehouse/">data-warehouse</a>
  </div>

 <!-- by blair add 160724-->
        <!--
        <div style="width:100px; height:30px;"></div> by blair add 160724
        -->
        
  <div class="article-tag">
    <a class="article-tag-link" href="/tags/SQL/" rel="tag">SQL</a>
  </div>


      </footer>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/03/18/dataware/SQL-Monkey/" id="article-nav-newer" class="article-nav-link-wrap">
      <div class="article-nav-title"><span>&lt;</span>&nbsp;
        
          猴子的图解SQL 学习笔记
        
      </div>
    </a>
  
  
    <a href="/2021/03/09/dataware/dwh-summary-4-project/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">DataWare Review Summary 4&nbsp;<span>&gt;</span></div>
    </a>
  
</nav>

  
</article>

<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</section>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Blair Chan&nbsp;
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, theme by <a href="http://github.com/52binge/hexo-theme-blairos" target="_blank" rel="noopener">blairos</a>
    </div>
  </div>
</footer>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX"],
    tex2jax: {
      inlineMath: [ ['$','$'], ['\\(','\\)'] ],
      displayMath: [ ['$$','$$']],
      processEscapes: true
    }
  });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML,http://myserver.com/MathJax/config/local/local.js">
</script>

    
<script type="text/javascript"> <!-- add by blair 0724 type=text/javascript -->
  var disqus_shortname = 'blairos-sn';
  
  var disqus_url = 'http://iequa.com/2021/03/12/dataware/dwh-summary-5-knowleage/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="/js/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>
